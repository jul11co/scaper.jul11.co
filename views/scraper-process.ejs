<%
if (link_html && cheerio) {

  // console.log(link_html);

  var $ = cheerio.load(link_html);

  page_url = link_url;

  page_title = $('title').first().text();
  page_description = $('meta[name*=description]').attr('content');
  if (page_title) {
    page_title = page_title.replace(/(\r\n|\n|\r)/gm, '');
  }
  if (page_description) {
    page_description = page_description.replace(/(\r\n|\n|\r)/gm, '');
  }

  // Open Graph meta tags
  var og_metadata = {
    url: $('meta[property="og:url"]').attr('content'),
    type: $('meta[property="og:type"]').attr('content'),
    title: $('meta[property="og:title"]').attr('content'),
    description: $('meta[property="og:description"]').attr('content'),
    image: $('meta[property="og:image"]').attr('content')
  };
  if (og_metadata.image) {
    page_image = og_metadata.image;
  }
  if (page_description == '' && og_metadata.description && og_metadata.description != '') {
    page_description = og_metadata.description.replace(/(\r\n|\n|\r)/gm, '');
  }

  console.log('Page title: ' + page_title);
  console.log('Page description: ' + page_description);
  
  var page_url_obj = urlutil.parse(page_url);
  var link_host_url = page_url.replace(page_url_obj.path, '');
  var link_host_url_obj = urlutil.parse(link_host_url);
  
  var normalizeLinks = function(_selector) {
    $('' + _selector + ' a').each(function(){
      var link_href = $(this).attr('href');
      if (link_href && link_href != "") {
        if (link_href.indexOf('mailto:') >= 0) {
          return;
        }
        if (link_href.indexOf('javascript:') == 0) {
          return;
        }
        if (link_href.indexOf('#') == 0) {
          return;
        }
        var link_url = link_href.replace('http:///', '/');
        var link_url_obj = urlutil.parse(link_url);
        if (!link_url_obj.host) {
          // console.log('Empty host: ' + link_url);
          link_url = urlutil.resolve(link_host_url_obj, link_url_obj);
          // $(this).attr('href', link_url);
        } else {
          link_url = urlutil.format(link_url_obj);
        }
        $(this).attr('href', '/scraper?link=' + encodeURIComponent(link_url));
        page_links.push(link_url);
      }
    });
  }

  var removeSelector = function(_selector) {
    console.log('Removing ' + _selector);
    if ($(_selector).length) {
      $(_selector).remove();
    }
  }

  var removeInlineScripts = function(_selector) {
    if ($('' + _selector + ' script').length) {
      $('' + _selector + ' script').remove();
    }
  }

  var elementExists = function(_selector) {
    if ($(_selector).length) {
      return true;
    }
    return false;
  }

  var urlMatch = function(_pattern) {
    if (page_url.indexOf(_pattern) >= 0) {
      return true;
    }
    return false;
  }

  var addCss = function(_css) {
    page_css += _css;
  }
  var setCss = function(_css) {
    page_css = _css;
  }

  var addHtml = function(_html) {
    page_html += _html;
  }
  var setHtml = function(_html) {
    page_html = _html;
  }

  var page_script_file = '';

  var setScriptFile = function(script_file) {
    page_script_file = script_file;
  }

  var postProcess = function() {
    if (page_html == '') {
      if ($('article').length) {
        removeInlineScripts('article');
        normalizeLinks('article');
        page_html = $('article').html(); 
      } else {
        removeInlineScripts('body');
        normalizeLinks('body');
        page_html = $('body').html();
      }
    }
    if (page_script_file != '') {
      page_script = readScriptFileSync(page_script_file);
    }
  }
%>

  <%include websites/wikipedia_org%>
  <%include websites/wikia_com%>
  <%include websites/stackoverflow_com%>
  <%include websites/quora_com%>
  <%include websites/engadget_com%>
  <%include websites/thenextweb_com%> 
  <%include websites/theverge_com%>
  <%include websites/techcrunch_com%>
  <%include websites/mashable_com%>
  <%include websites/venturebeat_com%>
  <%include websites/businessinsider_com%>
  <%include websites/androidcentral_com%>
  <%include websites/androidcommunity_com%>
  <%include websites/forbes_com%>
  <%include websites/wired_com%>
  <%include websites/geekwire_com%>
  <%include websites/macrumors_com%>
  <%include websites/9to5mac_com%>
  <%include websites/androidheadlines_com%>
  <%include websites/slate_com%>
  <%include websites/huffingtonpost_com%>
  <%include websites/arstechnica_com%>
  <%include websites/buzzfeed_com%>
  <%include websites/discovery_com%>
  <%include websites/cnet_com%>
  <%include websites/wikihow_com%>
  <%include websites/fortune_com%>
  <%include websites/bloomberg_com%>
  <%include websites/pcworld_com%>
  <%include websites/pcmag_com%>
  <%include websites/popularmechanics_com%>
  <%include websites/vogue_com%>
  <%include websites/technobuffalo_com%>
  <%include websites/extremetech_com%>

  <%include websites/tinhte_vn%>
  <%include websites/genk_vn%>
  <%include websites/kenh14_vn%>
  <%include websites/vnexpress_net%>
  <%include websites/24h_com_vn%> 
  <%include websites/soha_vn%>
  <%include websites/techz_vn%>
  <%include websites/vnreview_vn%>
  <%include websites/ictnews_vn%>

  <%include websites/vechai_info%>  
  <%include websites/truyentranh8_net%>  

<%
  postProcess();
}
%>